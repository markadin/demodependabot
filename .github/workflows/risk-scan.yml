name: SBOM & Risk Report (Dependabot)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  sbom_and_risk:
    # Run ONLY when Dependabot created the PR
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------------------
      # 1. Install Syft and generate SBOM
      # ------------------------------
      - name: Install Syft
        run: |
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin

      - name: Generate SBOM (CycloneDX JSON)
        run: syft dir:. -o cyclonedx-json > sbom.json

      # ------------------------------
      - name: Install Grype
        run: |
          curl -sSfL https://get.anchore.io/grype | sudo sh -s -- -b /usr/local/bin

      - name: Run vulnerability scan (Grype)
        run: |
          grype sbom:sbom.json -o json > grype.json
          # For log visibility
          grype sbom:sbom.json -o table | head -n 100 || true

      # ------------------------------
      # 2. Extract dependency updates from PR diff
      # ------------------------------
      - name: Extract dependency updates from PR diff
        run: |
          echo "## ðŸ“¦ Dependency Updates" > updates.md

          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git diff --name-only origin/${{ github.event.pull_request.base.ref }} > changed_files.txt

          DEP_FILES=$(grep -E '(package.json|package-lock.json|requirements|Pipfile|poetry.lock|pyproject.toml|pom.xml|gradle|go.mod|go.sum|Cargo.lock|Gemfile.lock|composer.lock)' changed_files.txt || true)

          if [ -z "$DEP_FILES" ]; then
            echo "_No dependency manifest or lockfile changes detected._" >> updates.md
            exit 0
          fi

          echo "**Changed dependency files:**" >> updates.md
          echo "$DEP_FILES" | sed 's/^/- `/' | sed 's/$/`/' >> updates.md
          echo "" >> updates.md
          echo "### ðŸ” Version changes" >> updates.md

          for FILE in $DEP_FILES; do
            echo "**$FILE**" >> updates.md
            git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "$FILE" | sed 's/^/    /' >> updates.md
            echo "" >> updates.md
          done

      # ------------------------------
      # 3. Severity summary + Critical table
      # ------------------------------
      - name: Build vulnerability summary
        run: |
          jq "
            [.matches[].vulnerability.severity]
            | group_by(.)
            | map({severity: .[0], count: length})
            | sort_by(.severity)
            | reverse
          " grype.json > /tmp/severity_counts.json
      
          echo "## ðŸ§® Severity Summary" > severity.md
          echo "| Severity | Count |" >> severity.md
          echo "|---|---:|" >> severity.md
          jq -r '.[] | "| \(.severity) | \(.count) |"' /tmp/severity_counts.json >> severity.md

      - name: Extract critical vulnerabilities
        run: |
          jq "
            [.matches[]
              | select(.vulnerability.severity==\"Critical\")
              | {
                  pkg: .artifact.name,
                  version: .artifact.version,
                  vuln: .vulnerability.id,
                  fix: (.vulnerability.fix.versions[0] // \"-\")
                }
            ]
          " grype.json > /tmp/critical_list.json
      
          echo "## â— Critical Vulnerabilities" > critical.md
          if [ "$(jq 'length' /tmp/critical_list.json)" -eq 0 ]; then
            echo "_No Critical vulnerabilities found._" >> critical.md
          else
            echo "| Package | Version | Vulnerability | Fix |" >> critical.md
            echo "|---|---|---|---|" >> critical.md
            jq -r '.[] | "| \(.pkg) | \(.version) | \(.vuln) | \(.fix) |"' /tmp/critical_list.json >> critical.md
          fi

      # ------------------------------
      # 4. SBOM summary (show unique components only)
      # ------------------------------
      - name: SBOM summary (first 100 unique components)
        run: |
          echo "## ðŸ§¾ SBOM (CycloneDX) â€“ first 100 unique components" > sbom.md
          echo "_Full SBOM attached as artifact (sbom.json)._" >> sbom.md
          echo "" >> sbom.md
          echo "| Component | Version | License |" >> sbom.md
          echo "|---|---|---|" >> sbom.md
      
          jq "
            (.components // [])
            | map({
                name: (.name // \"-\"),
                version: (.version // \"-\"),
                license: (
                  (.licenses[0].license.name) //
                  (.licenses[0].expression) //
                  \"-\"
                )
              })
            | unique_by(.name + \":\" + .version)
            | .[0:100]
          " sbom.json |
          jq -r '.[] | "| \(.name) | \(.version) | \(.license) |"' >> sbom.md

      # ------------------------------
      # 5. Build PR comment
      # ------------------------------
      - name: Assemble PR comment
        run: |
          {
            echo "## ðŸ”’ Dependency Risk Report (Dependabot)"
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo ""
            cat severity.md
            echo ""
            cat critical.md
            echo ""
            cat updates.md
            echo ""
            echo "<details><summary>SBOM (first 100 unique components)</summary>"
            echo ""
            cat sbom.md
            echo ""
            echo "</details>"
          } > report.md

      - name: Post PR comment
        uses: mshick/add-pr-comment@v2
        with:
          message-path: report.md

      # ------------------------------
      # 6. Upload artifacts
      # ------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-and-risk-report
          path: |
            sbom.json
            grype.json
            report.md

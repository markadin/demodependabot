# ---------------------------------------------------------------------------
# SBOM & Risk Report (Dependabot-only)
#
# Purpose
#   Produces an audit-ready SBOM and a vulnerability risk summary for every
#   Dependabot PR that updates dependencies. The job comments back on the PR
#   with:
#     ‚Ä¢ A severity summary (Critical/High/Medium/Low)
#     ‚Ä¢ A table of Critical vulnerabilities
#     ‚Ä¢ A readable ‚Äúdependency updates‚Äù diff (what changed, from ‚Üí to)
#     ‚Ä¢ A compact SBOM preview (first 100 unique components)
#   It also uploads the full machine-readable artifacts (SBOM + scan JSON).
#
# Why
#   This ensures each dependency change (SOUP update) is:
#     ‚Ä¢ Analyzed consistently
#     ‚Ä¢ Documented right in the PR for reviewers
#     ‚Ä¢ Backed by artifacts you can attach in your change records (e.g., Jira)
#
# When it runs
#   ‚Ä¢ Automatically on Pull Requests opened/updated by Dependabot only.
#   ‚Ä¢ It will NOT run on developer PRs to keep CI fast and focused.
#   ‚Ä¢ It will NOT fail the PR even if Critical issues are found (by design).
#
# How it works (high level)
#   1) Syft generates a CycloneDX JSON SBOM (sbom.json) for the repo contents.
#   2) Grype scans that SBOM and outputs a vulnerability report (grype.json).
#   3) The workflow computes:
#        - severity counts,
#        - a Critical vulns table (pkg, version, CVE, fix),
#        - a dependency diff from the PR (manifest/lockfile changes),
#        - a deduplicated SBOM preview (unique name:version pairs).
#   4) A single, formatted comment is posted on the PR for quick review.
#   5) All artifacts (SBOM + grype JSON + the rendered report) are uploaded.
#
# Inputs & outputs (artifacts)
#   ‚Ä¢ Input: the PR‚Äôs changed files (Dependabot updates).
#   ‚Ä¢ Output artifacts:
#       - sbom.json        (CycloneDX JSON, full component inventory)
#       - grype.json       (complete vulnerability findings)
#       - report.md        (the exact Markdown posted to the PR)
#
# Triggers & scope control
#   ‚Ä¢ Trigger: on: pull_request
#   ‚Ä¢ Scope: guarded by `if: github.event.pull_request.user.login == 'dependabot[bot]'`
#             so only Dependabot PRs run this heavy job.
#   ‚Ä¢ You can add `workflow_dispatch:` to run it manually for testing.
#
# Permissions (principle of least privilege)
#   ‚Ä¢ contents: read        ‚Äì to fetch repo contents
#   ‚Ä¢ issues: write         ‚Äì to post a regular PR comment (PRs are ‚Äúissues‚Äù)
#   ‚Ä¢ pull-requests: write  ‚Äì safe allowance for PR interactions
#
# Policy behavior (non-blocking)
#   ‚Ä¢ The job never fails the PR. Reviewers decide based on the comment.
#   ‚Ä¢ If you later want a policy gate, add a final step to fail on Critical/High
#     (but consider keeping Dependabot PRs non-blocking and enforce on dev PRs).
#
# How to run on demand (no waiting for schedule)
#   ‚Ä¢ In Dependabot page: ‚ÄúCheck for updates‚Äù (manual re-run) to create a PR.
#   ‚Ä¢ Or temporarily set your dependabot.yml schedule to `daily`, commit, then
#     switch back to `weekly` after testing.
#   ‚Ä¢ Or add `workflow_dispatch:` to this workflow and run it manually (will
#     skip if the event is not a Dependabot PR because of the job-level guard).
#
# Team expectations (review checklist)
#   ‚Ä¢ Read the PR comment:
#       - Review ‚Äúüì¶ Dependency Updates‚Äù for from‚Üíto changes
#       - Review ‚Äú‚ùó Critical Vulnerabilities‚Äù (fix available column helps)
#       - Scan the severity table (are counts increasing?)
#       - Expand the SBOM preview block if needed
#   ‚Ä¢ Use the uploaded artifacts for deeper analysis or to attach to your
#     change record (e.g., SOUP ticket in Jira).
#
# Troubleshooting
#   ‚Ä¢ ‚ÄúResource not accessible by integration‚Äù: ensure workflow permissions
#     include `issues: write` and `pull-requests: write`.
#   ‚Ä¢ ‚Äúunexpected EOF while looking for matching '‚Äù in jq steps:
#     make sure jq programs are wrapped in double quotes (") and escape any
#     internal quotes as \" (the file already follows this pattern).
#   ‚Ä¢ No dependency updates shown: Dependabot PR may not touch manifests/lockfiles,
#     or the diff is empty (e.g., PR only rebase). Check the ‚Äúchanged files‚Äù tab.
#   ‚Ä¢ No SBOM/vulns found: confirm Syft/Grype installed successfully in the log.
#
# Safe edits
#   ‚Ä¢ All workflows for PR events execute from the base branch copy (main);
#     update this file on main for changes to take effect on new PR runs.
#   ‚Ä¢ Keep the job guard for Dependabot-only runs unless you intend to scan
#     developer PRs as well (can be moved to a separate workflow if needed).
#
# Ownership
#   ‚Ä¢ Maintainer: Quality & Regulatory / Security (QRA)
#   ‚Ä¢ Contact: <your team or channel>
#
# ---------------------------------------------------------------------------

name: SBOM & Risk Report (Dependabot)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  sbom_and_risk:
    # Run ONLY when Dependabot created the PR
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------------------
      # 1. Install Syft and generate SBOM
      # ------------------------------
      - name: Install Syft
        run: |
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin

      - name: Generate SBOM (CycloneDX JSON)
        run: syft dir:. -o cyclonedx-json > sbom.json

      # ------------------------------
      - name: Install Grype
        run: |
          curl -sSfL https://get.anchore.io/grype | sudo sh -s -- -b /usr/local/bin

      - name: Run vulnerability scan (Grype)
        run: |
          grype sbom:sbom.json -o json > grype.json
          # For log visibility
          grype sbom:sbom.json -o table | head -n 100 || true

      # ------------------------------
      # 2. Extract dependency updates from PR diff
      # ------------------------------
      - name: Extract dependency updates from PR diff
        run: |
          echo "## üì¶ Dependency Updates" > updates.md

          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git diff --name-only origin/${{ github.event.pull_request.base.ref }} > changed_files.txt

          DEP_FILES=$(grep -E '(package.json|package-lock.json|requirements|Pipfile|poetry.lock|pyproject.toml|pom.xml|gradle|go.mod|go.sum|Cargo.lock|Gemfile.lock|composer.lock)' changed_files.txt || true)

          if [ -z "$DEP_FILES" ]; then
            echo "_No dependency manifest or lockfile changes detected._" >> updates.md
            exit 0
          fi

          echo "**Changed dependency files:**" >> updates.md
          echo "$DEP_FILES" | sed 's/^/- `/' | sed 's/$/`/' >> updates.md
          echo "" >> updates.md
          echo "### üîç Version changes" >> updates.md

          for FILE in $DEP_FILES; do
            echo "**$FILE**" >> updates.md
            git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "$FILE" | sed 's/^/    /' >> updates.md
            echo "" >> updates.md
          done

      # ------------------------------
      # 3. Severity summary + Critical table
      # ------------------------------
      - name: Build vulnerability summary
        run: |
          jq "
            [.matches[].vulnerability.severity]
            | group_by(.)
            | map({severity: .[0], count: length})
            | sort_by(.severity)
            | reverse
          " grype.json > /tmp/severity_counts.json
      
          echo "## üßÆ Severity Summary" > severity.md
          echo "| Severity | Count |" >> severity.md
          echo "|---|---:|" >> severity.md
          jq -r '.[] | "| \(.severity) | \(.count) |"' /tmp/severity_counts.json >> severity.md

      - name: Extract critical vulnerabilities
        run: |
          jq "
            [.matches[]
              | select(.vulnerability.severity==\"Critical\")
              | {
                  pkg: .artifact.name,
                  version: .artifact.version,
                  vuln: .vulnerability.id,
                  fix: (.vulnerability.fix.versions[0] // \"-\")
                }
            ]
          " grype.json > /tmp/critical_list.json
      
          echo "## ‚ùó Critical Vulnerabilities" > critical.md
          if [ "$(jq 'length' /tmp/critical_list.json)" -eq 0 ]; then
            echo "_No Critical vulnerabilities found._" >> critical.md
          else
            echo "| Package | Version | Vulnerability | Fix |" >> critical.md
            echo "|---|---|---|---|" >> critical.md
            jq -r '.[] | "| \(.pkg) | \(.version) | \(.vuln) | \(.fix) |"' /tmp/critical_list.json >> critical.md
          fi

      # ------------------------------
      # 4. SBOM summary (show unique components only)
      # ------------------------------
      - name: SBOM summary (first 100 unique components)
        run: |
          echo "## üßæ SBOM (CycloneDX) ‚Äì first 100 unique components" > sbom.md
          echo "_Full SBOM attached as artifact (sbom.json)._" >> sbom.md
          echo "" >> sbom.md
          echo "| Component | Version | License |" >> sbom.md
          echo "|---|---|---|" >> sbom.md
      
          jq '
            (.components // [])
            | map({
                name: (.name // "-"),
                version: (.version // "-"),
                license: (
                  # 1: Try CycloneDX license object
                  ( .licenses[0].license.name ) //
                  ( .licenses[0].expression ) //
      
                  # 2: Fallback: try Syft raw metadata field
                  ( .properties[]? | select(.name=="syft:metadata:package:license") | .value ) //
      
                  # 3: Fallback to "-"
                  "-"
                )
              })
            | unique_by(.name + ":" + .version)
            | .[0:100]
          ' sbom.json |
          jq -r '.[] | "| \(.name) | \(.version) | \(.license) |"' >> sbom.md

      # ------------------------------
      # 5. Build PR comment
      # ------------------------------
      - name: Assemble PR comment
        run: |
          {
            echo "## üîí Dependency Risk Report (Dependabot)"
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo ""
            cat severity.md
            echo ""
            cat critical.md
            echo ""
            cat updates.md
            echo ""
            echo "<details><summary>SBOM (first 100 unique components)</summary>"
            echo ""
            cat sbom.md
            echo ""
            echo "</details>"
          } > report.md

      - name: Post PR comment
        uses: mshick/add-pr-comment@v2
        with:
          message-path: report.md

      # ------------------------------
      # 6. Upload artifacts
      # ------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-and-risk-report
          path: |
            sbom.json
            grype.json
            report.md

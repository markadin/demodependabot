# ---------------------------------------------------------------------------
# SBOM & Risk Report (Dependabot-only)
#
# Purpose
#   Generates a complete Software Bill of Materials (SBOM) and a vulnerability
#   risk summary for every Dependabot pull request. The workflow posts a
#   detailed PR comment containing:
#     ‚Ä¢ A severity summary (Critical / High / Medium / Low)
#     ‚Ä¢ A table of Critical vulnerabilities with fix versions
#     ‚Ä¢ A readable dependency update diff (old ‚Üí new versions), always computed
#       against the PR base branch (e.g., main), even if Dependabot rebases or
#       refreshes its own branch.
#     ‚Ä¢ A compact SBOM preview (first 100 unique components)
#   It also uploads full machine-readable artifacts (SBOM + vulnerability scan).
#
# Why
#   This provides an audit-ready view of each dependency update (SOUP change)
#   directly inside the PR. According to GitHub‚Äôs documentation, Dependabot
#   version-update PRs are generated according to the ecosystems, directories,
#   and grouping rules specified in dependabot.yml, enabling maintainers to
#   inspect updates before merging.  [2](https://github.blog/changelog/2024-06-25-simplified-dependabot-yml-configuration-with-multi-directory-key-directories-and-wildcard-glob-support/)
#
#   The workflow ensures dependency changes are:
#     ‚Ä¢ Analyzed consistently
#     ‚Ä¢ Documented clearly
#     ‚Ä¢ Supported by artifacts suitable for Quality/Regulatory records
#
# When it runs
#   ‚Ä¢ Automatically for pull requests created/updated by Dependabot only.
#   ‚Ä¢ It does NOT run for developer PRs to keep CI fast and focused.
#   ‚Ä¢ It never fails the PR (non-blocking by design).
#
# How it works (high level)
#   1) Syft generates a CycloneDX SBOM (sbom.json) of the repository contents.  [3](https://sjramblings.io/github-actions-resource-not-accessible-by-integration/)
#   2) Grype scans the SBOM and produces a vulnerability report (grype.json).    [4](https://oss.anchore.com/docs/installation/syft/)
#   3) The workflow computes:
#        - Severity distribution
#        - Critical vulnerability table
#        - Dependency update diff using the PR base SHA ‚Üí head SHA, ensuring
#          correct diffs even after Dependabot rebase/update events
#        - Deduplicated SBOM preview (unique component@version pairs)
#   4) Posts a Markdown report as a PR comment.
#   5) Uploads artifacts (SBOM, vulnerabilities, final comment) for audit.
#
# Inputs & outputs (artifacts)
#   ‚Ä¢ Inputs: The PR‚Äôs dependency changes (manifest/lockfile updates)
#   ‚Ä¢ Output artifacts:
#       - sbom.json
#       - grype.json
#       - report.md
#
# Triggers & scope control
#   ‚Ä¢ Trigger: on: pull_request
#   ‚Ä¢ Guard: job only runs when PR author == dependabot[bot]
#   ‚Ä¢ Optional manual trigger via workflow_dispatch (skips unless Dependabot PR)
#
# Permissions (least privilege)
#   ‚Ä¢ contents: read        ‚Äì fetch repository contents
#   ‚Ä¢ issues: write         ‚Äì post PR comment (PRs are Issues in GitHub API) [4](https://oss.anchore.com/docs/installation/syft/)
#   ‚Ä¢ pull-requests: write  ‚Äì allow safe PR interactions
#
# Policy behavior (non-blocking)
#   ‚Ä¢ The workflow never fails the PR.
#   ‚Ä¢ If later required, a fail-gate step can be added (recommended: only for
#     developer PRs, not Dependabot PRs).
#
# How to run Dependabot on demand
#   ‚Ä¢ Insights ‚Üí Dependency Graph ‚Üí Dependabot ‚Üí Recent update jobs ‚Üí
#     ‚ÄúCheck for updates‚Äù (runs Dependabot version-update job).  
#   ‚Ä¢ Or temporarily change schedule in dependabot.yml to `daily`, commit, then
#     switch back to `weekly`.
#   ‚Ä¢ Or run this workflow manually.
#
# Team expectations
#   ‚Ä¢ Review ‚Äúüì¶ Dependency Updates‚Äù for old ‚Üí new versions
#   ‚Ä¢ Review ‚Äú‚ùó Critical Vulnerabilities‚Äù for security implications
#   ‚Ä¢ Review severity table and SBOM preview
#   ‚Ä¢ Download artifacts for deeper analysis or SOUP records
#
# Troubleshooting
#   ‚Ä¢ Missing dependency updates:
#       Dependabot may have rebased; diff uses base.sha ‚Üí head.sha to ensure
#       correct results regardless of Dependabot rebasing.
#   ‚Ä¢ Resource not accessible: check permissions include issues:write and
#       pull-requests:write.  [5](https://dev.to/arbythecoder/how-i-secured-my-containerized-application-using-anchore-day-29-project-474l)
#   ‚Ä¢ Unexpected EOF in jq: ensure jq blocks use double quotes.
#   ‚Ä¢ No SBOM/vulns: verify Syft/Grype install succeeded.
#
# Safe edits
#   ‚Ä¢ PR workflows always run using the workflow from the base branch (main);
#     merge workflow edits first for them to take effect.  [1](https://deepwiki.com/anchore/grype/5.2-release-pipeline)
#
# Ownership
#   ‚Ä¢ Maintainer: Quality & Regulatory / Security (QRA)
#   ‚Ä¢ Contact: <your team or channel>
#
# ---------------------------------------------------------------------------
name: SBOM & Risk Report (Dependabot)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  sbom_and_risk:
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # Checkout
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Dependabot Metadata (used ONLY for single-dep PRs)
      # --------------------------------------------------
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------------------
      # Install Syft
      # ------------------------------
      - name: Install Syft
        run: |
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin

      # ------------------------------
      # Prepare BASE + HEAD directories
      # ------------------------------
      - name: Prepare BASE worktree
        run: |
          git worktree add --detach /tmp/base "${{ github.event.pull_request.base.sha }}"

      # ------------------------------
      # Generate SBOMs (CycloneDX JSON)
      # ------------------------------
      - name: SBOM (BASE)
        run: syft dir:/tmp/base -o cyclonedx-json > sbom_base.json

      - name: SBOM (HEAD)
        run: syft dir:. -o cyclonedx-json > sbom_head.json

      # ------------------------------
      # Install Grype + scan SBOMs
      # ------------------------------
      - name: Install Grype
        run: |
          curl -sSfL https://get.anchore.io/grype | sudo sh -s -- -b /usr/local/bin

      - name: Grype scan (BASE + HEAD)
        run: |
          grype sbom:sbom_base.json -o json > grype_base.json || true
          grype sbom:sbom_head.json -o json > grype_head.json || true

      # ------------------------------
      # Dependency update diff (file list only)
      # ------------------------------
      - name: Dependency files changed
        run: |
          echo "## üì¶ Dependency Updates" > updates.md

          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          git diff --name-only "$BASE" "$HEAD" > /tmp/changed.txt

          DEP_FILES=$(grep -E '(Gemfile.lock|package-lock.json|npm-shrinkwrap.json|pom.xml|go.sum|Cargo.lock|composer.lock|Pipfile.lock|poetry.lock)' /tmp/changed.txt || true)

          if [[ -z "$DEP_FILES" ]]; then
            echo "_No dependency manifest or lockfile changes detected._" >> updates.md
          else
            echo "**Changed dependency files:**" >> updates.md
            echo "" >> updates.md
            echo "$DEP_FILES" | sed 's/^/- `/' | sed 's/$/`/' >> updates.md
          fi

      # ------------------------------
      # BASE vs HEAD Vulnerability Diff
      # ------------------------------
      - name: Compute vuln deltas
        run: |
          norm() {
            jq -r '
              .matches[]
              | [
                  (.artifact.name // "-"),
                  (.artifact.version // "-"),
                  (.vulnerability.id // "-"),
                  (.vulnerability.severity // "-"),
                  (.vulnerability.fix.versions[0] // "-")
                ] | join("|")
            ' "$1" | sort -u
          }

          norm grype_base.json > /tmp/base_v.txt
          norm grype_head.json > /tmp/head_v.txt

          comm -23 /tmp/base_v.txt /tmp/head_v.txt > /tmp/fixed.txt     # BASE only
          comm -13 /tmp/base_v.txt /tmp/head_v.txt > /tmp/new.txt       # HEAD only

          {
            echo "## ‚úÖ Vulnerabilities fixed by this PR"
            if [[ -s /tmp/fixed.txt ]]; then
              echo "| Package | Version | Vulnerability | Severity | Fix Version |"
              echo "|---|---|---|---|---|"
              awk -F'|' '{printf("| %s | %s | %s | %s | %s |\n",$1,$2,$3,$4,$5)}' /tmp/fixed.txt
            else
              echo "_No vulnerabilities were fixed._"
            fi
          } > fixed_vulns.md

          {
            echo "## üß© New vulnerabilities introduced by this PR"
            if [[ -s /tmp/new.txt ]]; then
              echo "| Package | Version | Vulnerability | Severity | Fix Version |"
              echo "|---|---|---|---|---|"
              awk -F'|' '{printf("| %s | %s | %s | %s | %s |\n",$1,$2,$3,$4,$5)}' /tmp/new.txt
            else
              echo "_No new vulnerabilities introduced._"
            fi
          } > new_vulns.md

      # ------------------------------
      # Severity tables (HEAD)
      # ------------------------------
      - name: Severity summary (HEAD)
        run: |
          jq '
            [.matches[].vulnerability.severity]
            | group_by(.)
            | map({severity: .[0], count: length})
            | sort_by(.severity)
            | reverse
          ' grype_head.json > /tmp/severity.json

          echo "## üßÆ Remaining Vulnerabilities (HEAD)" > severity.md
          echo "| Severity | Count |" >> severity.md
          echo "|---|---:|" >> severity.md
          jq -r '.[] | "| \(.severity) | \(.count) |"' /tmp/severity.json >> severity.md

      - name: Per-severity tables (HEAD)
        run: |
          make() {
            local sev="$1"
            local out="$2"

            jq "
              [.matches[]
                | select(.vulnerability.severity==\"${sev}\")
                | {
                    pkg: .artifact.name,
                    version: .artifact.version,
                    vuln: .vulnerability.id,
                    fix: (.vulnerability.fix.versions[0] // \"-\")
                  }
              ]
            " grype_head.json > "$out"

            {
              echo "## ${sev} Vulnerabilities (remaining)"
              if [[ $(jq length "$out") -eq 0 ]]; then
                echo "_No ${sev} vulnerabilities remain._"
              else
                echo "| Package | Version | Vulnerability | Fix |"
                echo "|---|---|---|---|"
                jq -r '.[] | "| \(.pkg) | \(.version) | \(.vuln) | \(.fix) |"' "$out"
              fi
            } > "${out}.md"
          }

          make "Critical" critical.json
          make "High"     high.json
          make "Medium"   medium.json

      # ------------------------------
      # SBOM summary (HEAD only)
      # ------------------------------
      - name: SBOM summary
        run: |
          echo "## üßæ SBOM (HEAD, first 100 components)" > sbom.md
          echo "| Component | Version | License |" >> sbom.md
          echo "|---|---|---|" >> sbom.md

          jq '
            (.components // [])
            | map({
                name: (.name // "-"),
                version: (.version // "-"),
                license: (
                  (.licenses[0].license.name) //
                  (.licenses[0].expression) //
                  "-"
                )
              })
            | unique_by(.name + ":" + .version)
            | .[0:100]
          ' sbom_head.json | jq -r '.[] | "| \(.name) | \(.version) | \(.license) |"' >> sbom.md

      # ------------------------------
      # LATEST AVAILABLE VERSIONS ‚Äî STRICT DIFF (OPTION B)
      # ------------------------------
      - name: Latest Available Versions (strict)
        shell: bash
        run: |
          set -euo pipefail

          echo "## üìå Latest Available Versions" > latest.md
          echo "" >> latest.md
          echo "| Package | Current | Latest | Ecosystem | Update |" >> latest.md
          echo "|---|---|---|---|---|" >> latest.md

          PKGS="${{ steps.metadata.outputs.dependency-names }}"
          ECO="${{ steps.metadata.outputs.package-ecosystem }}"
          TYPE="${{ steps.metadata.outputs.update-type }}"
          OLD="${{ steps.metadata.outputs.previous-version }}"
          NEW="${{ steps.metadata.outputs.new-version }}"

          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          # CASE 1 ‚Äî Single dependency PR ‚Üí use Dependabot metadata ONLY
          if [[ -n "$OLD" && -n "$NEW" ]]; then
            echo "| ${PKGS} | ${OLD} | ${NEW} | ${ECO} | ${TYPE} |" >> latest.md
            exit 0
          fi

          # CASE 2 ‚Äî Strict diff only for grouped PRs
          git diff --name-only "$BASE" "$HEAD" > /tmp/changed.txt

          DEP_FILES=$(grep -E '(Gemfile.lock|package-lock.json)' /tmp/changed.txt || true)

          rows=0

          parse_bundler() {
            awk '
              /^[[:space:]]+[A-Za-z0-9_.\-]+ \([0-9]/ {
                line=$0
                sub(/^[ \t]+/,"",line)
                name=line; sub(/ .*/,"",name)
                ver=line;  sub(/^[^ ]+ \(/,"",ver); sub(/\).*/,"",ver)
                print name " " ver
              }
            '
          }

          parse_npm() {
            jq -r '
              if has("packages") then
                (.packages | to_entries[]
                  | select(.key|startswith("node_modules/"))
                  | {n:(.key|sub("^node_modules/";"")),v:(.value.version//"")}
                )
              else
                (.dependencies//{}|to_entries[]|{n:.key,v:(.value.version//"")})
              end | select(.v!="") | "\(.n) \(.v)"
            '
          }

          while IFS= read -r f; do
            case "$f" in
              *Gemfile.lock)
                git show "${BASE}:${f}" > /tmp/base.lock || continue
                git show "${HEAD}:${f}" > /tmp/head.lock || continue

                parse_bundler < /tmp/base.lock | sort -u > /tmp/base.map
                parse_bundler < /tmp/head.lock | sort -u > /tmp/head.map

                join -a1 -a2 -e "-" -o auto -j 1 \
                  <(sort /tmp/base.map) <(sort /tmp/head.map) \
                | awk '{if($2!=$3) print $1, $2, $3}' \
                | while read -r n o nn; do
                    echo "| $n | $o | $nn | bundler | ${TYPE} |" >> latest.md
                    rows=$((rows+1))
                  done
                ;;

              *package-lock.json)
                git show "${BASE}:${f}" > /tmp/base.lock || continue
                git show "${HEAD}:${f}" > /tmp/head.lock || continue

                parse_npm < /tmp/base.lock | sort -u > /tmp/base.map
                parse_npm < /tmp/head.lock | sort -u > /tmp/head.map

                join -a1 -a2 -e "-" -o auto -j 1 \
                  <(sort /tmp/base.map) <(sort /tmp/head.map) \
                | awk '{if($2!=$3) print $1, $2, $3}' \
                | while read -r n o nn; do
                    echo "| $n | $o | $nn | npm | ${TYPE} |" >> latest.md
                    rows=$((rows+1))
                  done
                ;;
            esac
          done <<< "$DEP_FILES"

          # CASE 3 ‚Äî Strict behavior: no fallback at all for grouped PRs
          if [[ "$rows" -eq 0 ]]; then
            echo "_No dependency version changes detected._" >> latest.md
          fi

      # ------------------------------
      # Build PR Comment
      # ------------------------------
      - name: Assemble PR comment
        run: |
          {
            echo "## üîí Dependency Risk Report (Dependabot)"
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo ""

            cat fixed_vulns.md
            echo ""
            cat new_vulns.md
            echo ""
            cat severity.md
            echo ""
            cat critical.json.md
            echo ""
            cat high.json.md
            echo ""
            cat medium.json.md
            echo ""
            cat updates.md
            echo ""
            cat latest.md
            echo ""
            echo "<details><summary>SBOM (HEAD first 100)</summary>"
            cat sbom.md
            echo "</details>"
          } > report.md

      # ------------------------------
      # Upload Artifacts
      # ------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-and-risk-report
          path: |
            sbom_base.json
            sbom_head.json
            grype_base.json
            grype_head.json
            report.md

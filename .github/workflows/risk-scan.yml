# ---------------------------------------------------------------------------
# SBOM & Risk Report (Dependabot-only)
#
# Purpose
#   Generates a complete Software Bill of Materials (SBOM) and a vulnerability
#   risk summary for every Dependabot pull request. The workflow posts a
#   detailed PR comment containing:
#     ‚Ä¢ A severity summary (Critical / High / Medium / Low)
#     ‚Ä¢ A table of Critical vulnerabilities with fix versions
#     ‚Ä¢ A readable dependency update diff (old ‚Üí new versions), always computed
#       against the PR base branch (e.g., main), even if Dependabot rebases or
#       refreshes its own branch.
#     ‚Ä¢ A compact SBOM preview (first 100 unique components)
#   It also uploads full machine-readable artifacts (SBOM + vulnerability scan).
#
# Why
#   This provides an audit-ready view of each dependency update (SOUP change)
#   directly inside the PR. According to GitHub‚Äôs documentation, Dependabot
#   version-update PRs are generated according to the ecosystems, directories,
#   and grouping rules specified in dependabot.yml, enabling maintainers to
#   inspect updates before merging.  [2](https://github.blog/changelog/2024-06-25-simplified-dependabot-yml-configuration-with-multi-directory-key-directories-and-wildcard-glob-support/)
#
#   The workflow ensures dependency changes are:
#     ‚Ä¢ Analyzed consistently
#     ‚Ä¢ Documented clearly
#     ‚Ä¢ Supported by artifacts suitable for Quality/Regulatory records
#
# When it runs
#   ‚Ä¢ Automatically for pull requests created/updated by Dependabot only.
#   ‚Ä¢ It does NOT run for developer PRs to keep CI fast and focused.
#   ‚Ä¢ It never fails the PR (non-blocking by design).
#
# How it works (high level)
#   1) Syft generates a CycloneDX SBOM (sbom.json) of the repository contents.  [3](https://sjramblings.io/github-actions-resource-not-accessible-by-integration/)
#   2) Grype scans the SBOM and produces a vulnerability report (grype.json).    [4](https://oss.anchore.com/docs/installation/syft/)
#   3) The workflow computes:
#        - Severity distribution
#        - Critical vulnerability table
#        - Dependency update diff using the PR base SHA ‚Üí head SHA, ensuring
#          correct diffs even after Dependabot rebase/update events
#        - Deduplicated SBOM preview (unique component@version pairs)
#   4) Posts a Markdown report as a PR comment.
#   5) Uploads artifacts (SBOM, vulnerabilities, final comment) for audit.
#
# Inputs & outputs (artifacts)
#   ‚Ä¢ Inputs: The PR‚Äôs dependency changes (manifest/lockfile updates)
#   ‚Ä¢ Output artifacts:
#       - sbom.json
#       - grype.json
#       - report.md
#
# Triggers & scope control
#   ‚Ä¢ Trigger: on: pull_request
#   ‚Ä¢ Guard: job only runs when PR author == dependabot[bot]
#   ‚Ä¢ Optional manual trigger via workflow_dispatch (skips unless Dependabot PR)
#
# Permissions (least privilege)
#   ‚Ä¢ contents: read        ‚Äì fetch repository contents
#   ‚Ä¢ issues: write         ‚Äì post PR comment (PRs are Issues in GitHub API) [4](https://oss.anchore.com/docs/installation/syft/)
#   ‚Ä¢ pull-requests: write  ‚Äì allow safe PR interactions
#
# Policy behavior (non-blocking)
#   ‚Ä¢ The workflow never fails the PR.
#   ‚Ä¢ If later required, a fail-gate step can be added (recommended: only for
#     developer PRs, not Dependabot PRs).
#
# How to run Dependabot on demand
#   ‚Ä¢ Insights ‚Üí Dependency Graph ‚Üí Dependabot ‚Üí Recent update jobs ‚Üí
#     ‚ÄúCheck for updates‚Äù (runs Dependabot version-update job).  
#   ‚Ä¢ Or temporarily change schedule in dependabot.yml to `daily`, commit, then
#     switch back to `weekly`.
#   ‚Ä¢ Or run this workflow manually.
#
# Team expectations
#   ‚Ä¢ Review ‚Äúüì¶ Dependency Updates‚Äù for old ‚Üí new versions
#   ‚Ä¢ Review ‚Äú‚ùó Critical Vulnerabilities‚Äù for security implications
#   ‚Ä¢ Review severity table and SBOM preview
#   ‚Ä¢ Download artifacts for deeper analysis or SOUP records
#
# Troubleshooting
#   ‚Ä¢ Missing dependency updates:
#       Dependabot may have rebased; diff uses base.sha ‚Üí head.sha to ensure
#       correct results regardless of Dependabot rebasing.
#   ‚Ä¢ Resource not accessible: check permissions include issues:write and
#       pull-requests:write.  [5](https://dev.to/arbythecoder/how-i-secured-my-containerized-application-using-anchore-day-29-project-474l)
#   ‚Ä¢ Unexpected EOF in jq: ensure jq blocks use double quotes.
#   ‚Ä¢ No SBOM/vulns: verify Syft/Grype install succeeded.
#
# Safe edits
#   ‚Ä¢ PR workflows always run using the workflow from the base branch (main);
#     merge workflow edits first for them to take effect.  [1](https://deepwiki.com/anchore/grype/5.2-release-pipeline)
#
# Ownership
#   ‚Ä¢ Maintainer: Quality & Regulatory / Security (QRA)
#   ‚Ä¢ Contact: <your team or channel>
#
# ---------------------------------------------------------------------------

name: SBOM & Risk Report (Dependabot)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  sbom_and_risk:
    # Run ONLY when Dependabot created the PR
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------------------
      # 1. Install Syft and generate SBOM
      # ------------------------------
      - name: Install Syft
        run: |
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin

      - name: Generate SBOM (CycloneDX JSON)
        run: syft dir:. -o cyclonedx-json > sbom.json

      # ------------------------------
      - name: Install Grype
        run: |
          curl -sSfL https://get.anchore.io/grype | sudo sh -s -- -b /usr/local/bin

      - name: Run vulnerability scan (Grype)
        run: |
          grype sbom:sbom.json -o json > grype.json
          # For log visibility
          grype sbom:sbom.json -o table | head -n 100 || true

      # ------------------------------
      # 2. Dependency updates (no table)
      # ------------------------------
      - name: Extract dependency updates from PR diff
        run: |
          echo "## üì¶ Dependency Updates" > updates.md
      
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
      
          # List changed files between base ‚Üí PR head
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt
      
          # Consider common dependency manifests/lockfiles (adjust as you need)
          DEP_FILES=$(grep -E '(package.json|package-lock.json|Gemfile|Gemfile.lock|requirements|Pipfile|poetry.lock|pyproject.toml|go.mod|go.sum|Cargo.lock|composer.lock)' changed_files.txt || true)
      
          if [ -z "$DEP_FILES" ]; then
            echo "_No dependency manifest or lockfile changes detected._" >> updates.md
            exit 0
          fi
      
          echo "**Changed dependency files:**" >> updates.md
          echo "" >> updates.md
          echo "$DEP_FILES" | sed 's/^/- `/' | sed 's/$/`/' >> updates.md
          
      # ------------------------------
      # 3. Severity summary + Detailed tables (Critical, High, Medium)
      # ------------------------------
      - name: Build vulnerability summary
        run: |
          jq "
            [.matches[].vulnerability.severity]
            | group_by(.)
            | map({severity: .[0], count: length})
            | sort_by(.severity)
            | reverse
          " grype.json > /tmp/severity_counts.json

          echo "## üßÆ Severity Summary" > severity.md
          echo "| Severity | Count |" >> severity.md
          echo "|---|---:|" >> severity.md
          jq -r '.[] | "| \(.severity) | \(.count) |"' /tmp/severity_counts.json >> severity.md

      - name: Extract vulnerabilities by severity (Critical / High / Medium)
        run: |
          #################################################################
          # Helper to build a table for a given severity into a given file
          #################################################################
          make_table() {
            local severity="$1"
            local outfile="$2"

            jq "
              [.matches[]
                | select(.vulnerability.severity==\"${severity}\")
                | {
                    pkg: .artifact.name,
                    version: .artifact.version,
                    vuln: .vulnerability.id,
                    fix: (.vulnerability.fix.versions[0] // \"-\")
                  }
              ]
            " grype.json > "$outfile"

            local count
            count=$(jq 'length' "$outfile")

            # Write section header + table (or 'none found') into the same file
            # so each severity file is self-contained and easy to include later.
            {
              echo "## ${severity} Vulnerabilities"
              if [ "$count" -eq 0 ]; then
                echo "_No ${severity} vulnerabilities found._"
              else
                echo "| Package | Version | Vulnerability | Fix |"
                echo "|---|---|---|---|"
                jq -r '.[] | "| \(.pkg) | \(.version) | \(.vuln) | \(.fix) |"' "$outfile"
              fi
            } > "${outfile}.md"
          }

          # Generate all three severities
          make_table "Critical" "/tmp/critical_list.json"
          make_table "High"     "/tmp/high_list.json"
          make_table "Medium"   "/tmp/medium_list.json"

          # Move to predictable filenames used by the assemble step
          mv /tmp/critical_list.json.md critical.md
          mv /tmp/high_list.json.md     high.md
          mv /tmp/medium_list.json.md   medium.md

      # ------------------------------
      # 4. SBOM summary (show unique components only)
      # ------------------------------
      - name: SBOM summary (first 100 unique components)
        run: |
          echo "## üßæ SBOM (CycloneDX) ‚Äì first 100 unique components" > sbom.md
          echo "_Full SBOM attached as artifact (sbom.json)._" >> sbom.md
          echo "" >> sbom.md
          echo "| Component | Version | License |" >> sbom.md
          echo "|---|---|---|" >> sbom.md
      
          jq '
            (.components // [])
            | map({
                name: (.name // "-"),
                version: (.version // "-"),
                license: (
                  # 1: Try CycloneDX license object
                  ( .licenses[0].license.name ) //
                  ( .licenses[0].expression ) //
      
                  # 2: Fallback: try Syft raw metadata field
                  ( .properties[]? | select(.name=="syft:metadata:package:license") | .value ) //
      
                  # 3: Fallback to "-"
                  "-"
                )
              })
            | unique_by(.name + ":" + .version)
            | .[0:100]
          ' sbom.json |
          jq -r '.[] | "| \(.name) | \(.version) | \(.license) |"' >> sbom.md

      # ------------------------------
      # 5. Build PR comment
      # ------------------------------
      - name: Assemble PR comment
        run: |
          {
            echo "## üîí Dependency Risk Report (Dependabot)"
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo ""

            # Severity summary
            cat severity.md
            echo ""

            # Critical / High / Medium
            cat critical.md
            echo ""
            cat high.md
            echo ""
            cat medium.md
            echo ""

            # Dependency updates
            cat updates.md
            echo ""

            # SBOM preview
            echo "<details><summary>SBOM (first 100 unique components)</summary>"
            echo ""
            cat sbom.md
            echo ""
            echo "</details>"
          } > report.md

      - name: Post PR comment
        uses: mshick/add-pr-comment@v2
        with:
          message-path: report.md

      # ------------------------------
      # 6. Upload artifacts
      # ------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-and-risk-report
          path: |
            sbom.json
            grype.json
            report.md
